<% include ../include/header %>
<div id="wrapper">
    <% include ../include/nav %>
    <div id="page-wrapper" class="gray-bg dashbard-1">
        <% include ../include/navbar %>
        <% include ../include/contentTop %>
        <div class="wrapper wrapper-content">
            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <h5>添加客户</h5>
                        </div>
                        <div class="ibox-content">
                            <form class="form-horizontal m-t" action="" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="id" id="id" value="<%= article._id%>">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">标题：</label>
                                    <div class="col-sm-8">
                                        <input id="articleTitle" name="articleTitle" class="form-control" type="text"
                                               value="<%= article.title %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">发布时间：</label>
                                    <div class="col-sm-8">
                                        <input id="date" size="16" name="date" class="form-control" type="text"
                                               value="<%= article.date %>" readonly>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">栏目：</label>
                                    <div class="col-sm-8">
                                        <select name="articleSort" id="articleSort" class="form-control">
                                            <option value="0"
                                                    <% if(article.sortName == 0){ %>
                                                    selected
                                                    <% } %>
                                            >规章制度
                                            </option>
                                            <option value="1"
                                                    <% if(article.sortName == 1){ %>
                                                    selected
                                                    <% } %>
                                            >通知公告
                                            </option>
                                            <option value="2"
                                                    <% if(article.sortName == 2){ %>
                                                    selected
                                                    <% } %>
                                            >公司要闻
                                            </option>
                                        </select>
                                    </div>

                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">文章简介：</label>
                                    <div class="col-sm-8">
                                        <div class="seditor" id="seditor1"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">文章内容：</label>
                                    <div class="col-sm-8">
                                        <div class="seditor" id="seditor2"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">文章附件：</label>
                                    <div class="col-sm-8" id="uploader">
                                        <div id="thelist" class="uploader-list"></div>
                                        <div class="btns">
                                            <div id="picker">选择文件</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">作者：</label>
                                    <div class="col-sm-8">
                                        <input id="articleAuthor" name="articleAuthor" class="form-control" type="text"
                                               value="<%= user.username %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">审核状态：</label>
                                    <div class="col-sm-8">
                                        <div class="radio i-checks">
                                            <label>
                                                <input type="radio" value="0" name="isChecked"> <i></i>
                                                待审核</label>
                                        </div>
                                        <div class="radio i-checks">
                                            <label>
                                                <input type="radio" checked="" value="1" name="isChecked"> <i></i>
                                                已审核</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">是否置顶：</label>
                                    <div class="col-sm-8">
                                        <div class="radio i-checks">
                                            <label><input type="radio" value="1" name="isToped"> <i></i>已置顶</label>
                                        </div>
                                        <div class="radio i-checks">
                                            <label><input type="radio" checked="" value="0" name="isToped">
                                                <i></i>未置顶</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">是否推荐：</label>
                                    <div class="col-sm-8">
                                        <div class="radio i-checks">
                                            <label>
                                                <input type="radio" value="1" name="isRecommend"> <i></i>已推荐</label>
                                        </div>
                                        <div class="radio i-checks">
                                            <label>
                                                <input type="radio" checked="" value="0" name="isRecommend">
                                                <i></i> 未推荐</label>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    <%
                                        if(article._id){
                                            %>
                                            var isChecked = '<%= article.state.isChecked %>';
                                            var isToped = '<%= article.state.isToped %>';
                                            var isRecommend = '<%= article.state.isRecommend %>';

                                            var checks = $('input[type=radio]');
                                            checks.removeAttr('checked');

                                            checks.each(function () {
                                                if ($(this).attr('name') == 'isChecked' && $(this).val() == isChecked) {
                                                    $(this).prop('checked',true);
                                                } else if ($(this).attr('name') == 'isToped' && $(this).val() == isToped) {
                                                    $(this).prop('checked', true);
                                                } else if ($(this).attr('name') == 'isRecommend' && $(this).val() == isRecommend) {
                                                    $(this).prop('checked', true);
                                                }
                                            })
                                    <%
                                        }
                                      %>
                                </script>
                                <div class="form-group">
                                    <div class="col-sm-8 col-sm-offset-3">
                                        <button class="btn btn-primary" id="save" type="submit">保存内容</button>
                                        <button class="btn btn-primary" type="reset">取消</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% include ../include/copy %>
    </div>
</div>
<!--编辑器-->
<link rel="stylesheet" href="/js/plugins/summernote/summernote.css">
<script src="/js/plugins/summernote/summernote.min.js"></script>
<script src="/js/plugins/summernote/summernote-zh-CN.js"></script>

<!--时间选择器-->
<link href="/css/plugins/datapicker/datepicker3.css" rel="stylesheet">
<script src="/js/plugins/datapicker/bootstrap-datepicker.js"></script>

<!--文件上传-->
<link rel="stylesheet" href="/js/plugins/webuploader/webuploader.css">
<script src="/js/plugins/webuploader/webuploader.min.js"></script>

<script>

    $(function () {
        $('#date').datepicker({
            todayBtn: "linked",
            keyboardNavigation: false,
            forceParse: false,
            calendarWeeks: true,
            autoclose: true,
            format: "yyyy-mm-dd",
            todayHighlight: true,
            initialDate: new Date()
        });

        if ($('.seditor').length != 0) {
            /*
             * 配置编辑器基本设置
             * */
            var seditor = $('.seditor');
            seditor.eq(0).summernote({
                lang: 'zh-CN',
                height: 80,
                toolbar: [],
                shortcuts: false
            });

            seditor.eq(1).summernote({
                lang: 'zh-CN',
                minHeight: 300,
                maxHeight: null,
                toolbar: [
                    ['misc', ['fullscreen', 'codeview', 'undo', 'redo']],
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['fontsize', ['fontsize']],
                    ['fontname', ['fontname']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['insert', ['picture', 'link', 'table', 'hr']]
                ],
                shortcuts: false
            });

            /*
             * summernote 提交文本内容及图片信息
             * webupload 提交其他文件信息，服务器压缩成zip包，作为附件下载
             * ajax提交所有字段信息
             *
             * */
            /*
             * 编辑添加数据
             * */
            var desc = '<%- article.desc %>';
            var content = '<%- article.content %>';

            if (desc) {
                $('#seditor1').summernote('code', desc);
                $('#seditor2').summernote('code', content);
            }

            var BASE_URL = '../js/plugins/webuploader/';
            var uploader = WebUploader.create({
                swf: BASE_URL + '/Uploader.swf',
                server: '/rules/addinx/',
                pick: '#picker',
                resize: false,
                auto: true
            });

            uploader.on('fileQueued', function (file) {
                $('#thelist').append('<div id="' + file.id + '" class="item">' +
                        '<h4 class="info">' + file.name + '</h4>' +
                        '<p class="state">等待上传...</p>' +
                        '</div>');
            });

            // 文件上传过程中创建进度条实时显示。
            uploader.on('uploadProgress', function (file, percentage) {
                var $li = $('#' + file.id),
                        $percent = $li.find('.progress .progress-bar');
                if (!$percent.length) {
                    $percent = $('<div class="progress progress-striped active">' +
                            '<div class="progress-bar" role="progressbar" style="width: 0%">' +
                            '</div>' +
                            '</div>').appendTo($li).find('.progress-bar');
                }
                $li.find('p.state').text('上传中');
                $percent.css('width', percentage * 100 + '%');
            });

            uploader.on('uploadSuccess', function (file,response) {
                $('#' + file.id).find('p.state').text('已上传');
                console.log(response);
            });

            uploader.on('uploadError', function (file) {
                $('#' + file.id).find('p.state').text('上传出错');
            });

            uploader.on('uploadComplete', function (file) {
                $('#' + file.id).find('.progress').fadeOut();
            });

            $('#save').on('click', function () {
                alert('开始保存');
                $.ajax({
                    method: 'POST',
                    url: '/rules/add/',
                    data: {
                        id:$('#id').val(),
                        title: $('#articleTitle').val(),
                        date: $('#date').val(),
                        sortName: $('#articleSort').val(),
                        desc: $('.seditor').eq(0).summernote('code'),
                        content: $('.seditor').eq(1).summernote('code'),
                        author: $('#articleAuthor').val(),
                        state: JSON.stringify({
                            'isChecked': $('input[name=isChecked]:checked').val(),
                            'isToped': $('input[name=isToped]:checked').val(),
                            'isRecommend': $('input[name=isRecommend]:checked').val()
                        })
                    },
                    success: function (data) {
                        location.href = '/rules/list';
                    }
                })
                return false;
            })

            //取消
        }
    })
</script>

<% include ../include/footer %>